# CPU的概述
## CPU功能
### 指令控制
- 完成取指令、分析指令和执行指令的操作，即程序的顺序控制。
### 操作控制
- 管理并产生由内存取出的每条指令的操作信号
- 把各种操作信号送往相应的部件，从而控制这些部件按指令的要求进行动作。
### 时间控制
- 对各种操作进行时间上的控制，要为每一条指令按时间顺序提供应有的控制信号。
### 数据加工
对数据进行算数和逻辑运算
### 中断处理
- 对计算机运行过程中出现的异常情况和特殊请求进行处理。
## CPU的组成
运算器+控制器
## CPU寄存器的分类
### 用户可见的寄存器
- 可对这类寄存器编程
- e.g. 通用寄存器，PSW，基址寄存器（用于实现多道程序设计或者编制浮动程序），状态/标志寄存器
### 用户不可见的寄存器
- 对用户是透明的
- 保留各种状态信息
- 如溢出标志OF，符号标志SF，零标志ZF，进位标志CF
- PSW中的这些位参与并决定微操作的形成
- 不可对这类寄存器编程
- e.g. MAR，MDR，IR，微程序控制器CM


- 转移指令时，需要判别转移是否成功，若成功则PC修改为转移指令的目标地址，否则下一条指令的地址仍然为PC自增后的地址
- 计算机分两大部分：控制部件和执行部件
	- 控制器就是控制部件，指令寄存器，操作控制器，程序计数器都是控制部件
	- 运算器，存储器，外围设备就是执行部件

- 各寄存器的位数等于什么？【和地址有关的就取决于机器字长，和数据大小有关的就取决于容量】

|通用寄存器     |   PC  | IR | MAR | MDR|
| --- | --- | --- | --- | --- |
|  机器字长   | 存储器容量    | 指令字长 | 指令字长| 机器字长=CPU的位数 |

# 运算器和控制器的对比
## 运算器
### 功能
- 接收从控制器送来的命令并执行相应的动作，对数据进行加工和处理
- 运算器是计算机对数据进行加工处理的中心、
### 组成
| 英文  | 中文       | 简述                            |
|-----|----------|-------------------------------|
| ALU | 算术逻辑单元   | • 进行算术/逻辑运算                   |
| PSW | 程序状态字寄存器 | • PSW存放程序状态字，用于保存系统的运行状态      |
|     |          | • PSW包括状态标志和控制标志              |
|     |          | • 溢出标志OF，符号标志SF，零标志ZF，进位标志CF  |
|     |          | • 中断标志，陷阱标志                   |
| ACC | 累加寄存器    | • 是一个通用寄存器                    |
|     |          | • 暂放ALU运算的结果信息，可作为加法运算的输入端    |
|     | 通用寄存器组   | • 如AX，BX，CX，DX，SP             |
|     |          | • 用于存放操作数和各种地址信息，所以其位数与机器字长相等 |
|     |          | • SP是堆栈指针，用于指示栈顶的地址           |
|     | 暂存寄存器    | • 暂存从主存读来的数据，对应用程序员透明         |
|     | 移位器      | • 对操作数或运算结果进行移位运算             |
|     | 计数器      | • 控制乘除运算的操作步数                 |
## 控制器
### 功能
从主存中取出指令，分析指令并产生有关的操作控制信号
### 组成
| 英文  | 中文       | 简述                                    |
|-----|----------|---------------------------------------|
| PC  | 程序计数器    | • 用于指出下一条指令在主存中的存放地址（PC总是存放指令地址）      |
|     |          | • PC有自增功能                             |
|     |          | • PC的值会根据CPU在执行指令过程中自增或转移到程序的某处(跳转指令) |
|     |          | • PC的位数取决于存储器的容量                      |
| IR  | 指令寄存器    | • 用于保存当前正在执行的那条指令                     |
|     |          | • IR的位数取决于指令字长                        |
| ID  | 指令译码器    | • 仅对操作码字段进行译码，以确定指令的操作功能              |
| MAR | 存储器地址寄存器 | • 存放要访问的主存单元的地址【存地址Memory address】    |
| MDR | 存储器数据寄存器 | • 存放向主存写入的信息或从主存读出的信息【存数据Memory data】 |
|     |          | • n位CPU的n是指数据总线线数（即数据总线的位数=处理器的位数）    |
|     | 时序系统     | • 用于产生各种时序信号，都由统一时钟CLOCK分频得到          |
|     | 微操作信号发生器 | • 根据IR的内容(指令)，PSW的内容(状态信息)和时序信号       |
|     |          | • 产生控制计算机系统所需的各种控制信号                  |
|     |          | • 结构有组合逻辑型和存储逻辑型                      |
# 控制器的功能和工作原理
## 控制器的结构和功能
### 结构
![1719397784183](https://github.com/user-attachments/assets/f364f2f5-acd9-4b60-a143-23b79040280c)
### 连接关系
| 运算器            | • 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据 |
|----------------|----------------------------------|
| 输入设备和输出设备      | • 输入设备和输出设备通过接口电路与总线相连接          |
| 内存储器、输入设备和输出设备 | • 内存储器、输入设备和输出设备从地址总线接收地址信息      |
|                | • 从控制总线得到控制信号，通过数据总线与其他部件传送数据    |
| 控制器部件          | • 控制器部件从数据总线接受指令信息               |
|                | • 从运算器部件接受指令转移地址，送出指令地址到地址总线     |
|                | • 还要向系统中的部件提供它们运行所需要的控制信号        |
**根据控制器产⽣微操作信号的⽅式的不同，控制器可以分为硬布线控制器和微程序控制器**
## 硬布线控制器和微程序控制器
### 硬布线控制器(RISC)
#### 工作原理
需要结合各微操作的节拍安排，综合分析，写出逻辑表达式，再设计逻辑电路图
#### 特点
- 采用硬件电路，速度快
- 设计难度大，成本高，不易扩展
- 时序系统复杂
#### 基本原理
- 根据指令的要求、当前的时序及外部和内部的状态，按时间顺序发送一系列微操作控制信号
- 是由复杂的组合逻辑门电路和一些触发器构成，又称组合逻辑控制器
#### 硬布线控制单元图
CU的输入信号来源
- 经指令编译器译码产生的
- 时序系统产生的机器周期信号和节拍信号
- 来自执行单元的反馈信号，即标志

![Pasted image 20240626183839](https://github.com/user-attachments/assets/f93d66ea-3279-456c-b914-0bac5cbb1e5d)

#### 硬布线控制器的时序系统及微操作
- 时钟周期：用时钟信号控制节拍发生器，可以产生节拍，每个节拍的宽度正好对应一个时钟周期
- 机器周期：可以视为所有指令执行过程中的一个基准时间
- 指令周期：CPU从主存中取出并执行一条指令的时间称为指令周期
- 微操作命令分析：控制单元发出各种操作命令序列的功能
#### CPU的控制方式
| 同步控制方式 | • 系统有一个统一的时钟，所有的控制信号都来源于这个统一的时钟信号        |
|--------|------------------------------------------|
|        | • 通常以最长的微操作序列和最繁琐的微操作作为标准                |
|        | • 采取完全统一的、具有相同时间间隔和相同数目的节拍作为机器周期来运行不同的指令 |
|        | • 优点：控制电路简单                              |
|        | • 缺点：运行速度慢                               |
| 异步控制方式 | • 不存在基准时标信号，各部件按照自身固有速度工作，通过应答方式进行联络     |
|        | • 优点：运行速度快                               |
|        | • 缺点：控制电路较为复杂                            |
| 联合控制方式 | • 介于同步、异步之间的一种折中                         |
|        | • 对大部分采用同步控制，小部分采用异步控制                   |

- 微操作控制信号的形成主要与指令译码信号和时钟信号有关（见CU的输入信号来源）
- 微处理器与微程序控制器没有必然联系，微处理器是相对于一些大型处理器而言的
- 微机的CPU都是微处理器

- 各种“微”的关系
	- 每条机器指令编写成一个微程序
	- 每个微程序包含若干微指令
	- 每条微指令对应一个或几个微操作命令
	- 机器指令---->微程序---->微指令----->微操作命令
### 微程序控制器(CISC CPU)
#### 工作原理
按照节拍的安排，顺序执行微操作
#### 特点
- 速度较慢（主要是因为增加了从CM读取微指令的时间）
- 灵活性高，易扩充修改
- 时序系统简单
#### 基本原理
- 采用存储逻辑实现，即把微操作信号代码化
#### 基本思想
- 将每条机器指令编写成一个微程序，每个微程序包含若干微指令，每条微指令对应一个或几个微操作命令
- 机器指令---->微程序---->微指令----->微操作命令
- 这些微程序可以存到一个控制存储器中，用寻址用户程序机器指令的办法来寻址每个微程序中微指令
#### 基本概念
| 微命令与微操作    | • 微操作是计算机中最基本、不可再分解的操作；微命令执行的操作叫做微操作  |
|------------|---------------------------------------|
|            | • 微命令将控制部件向执行部件发出的各种控制命令；是构成控制序列的最小单位 |
| 微指令和微周期    | • 微指令是若干微命令的集合                        |
|            | • 微地址存放微指令的控制存储器的单元地址                 |
|            | • 微周期指的是从控制存储器中读取一条微指令并执行相应的微操作所需的时间  |
|            | • 微指令的两个组成部分：微操作码字段和微地址码字段            |
| 主存储器与控制存储器 | • 主存用于存放程序和数据，在CPU外部，用RAM实现；          |
|            | • CM用于存放微程序，在CPU内部，用ROM实现。            |
| 程序与微程序     | • 程序是指令的有序集合，用于完成特定的功能；               |
|            | • 微程序是微指令的有序集合，一条指令的功能由一段微程序实现。       |
| 微程序和机器指令   | • 一般来说，一条机器指令对应一个微程序                  |
#### 寄存器分类
| 地址寄存器  | 存放主存的读写地址        |
|--------|------------------|
| 微地址寄存器 | 存放控制存储器的读写微指令的地址 |
| 指令寄存器  | 存放从主存中读出的指令      |
| 微指令寄存器 | 存放从控制存储器中读出的微指令  |
#### 基本组成
控制存储器：核心部件，用于存放各指令对应的微程序，控制存储器可用ROM构成 \
微指令寄存器：存放从CM中取出的微指令，位数与微指令字长相等 \
微地址形成部件：用于产生初始微地址和后继微地址，以保证微指令的连续执行 \
微地址寄存器：接受微地址形成部件送来的微地址，为在CM中读取微指令做准备

![Pasted image 20240626185011](https://github.com/user-attachments/assets/828c0c53-45a4-4b8c-afcf-c2058ab2eefe)
#### 工作过程
1. 执行取微指令公共操作
2. 由机器指令的操作码字段通过微地址形成部件产生该及其指令所对应的微程序的入口地址，并送入CMAR【微程序入口地址是机器指令的操作码字段】
3. 从CM中逐条取出对应的微指令并执行
4. 执行完对应于一条机器指令的一个微程序后，又回到取指微程序的入口地址，继续第一步
#### 编码方式与控制方式
| 目的      | 保证速度的情况下尽量缩短指令字长                              |
|---------|-----------------------------------------------|
| 直接编码方式  | • 无需进行译码，微指令的微命令字段中的每一位都代表一个微命令（选用“1”，不选用“0”） |
|         | • 优点：简单、直观、执行速度快，操作并行性好                       |
|         | • 缺点：微指令字长过长，n个微指令就要求微指令的操作字段有n位，造成控制存储器容量极大  |
| 字段直接编码法 | • 将微命令字段分成若干小字段，将互斥性微命令组合在同一字段中               |
|         | • 把相容性微命令组合在不同字段中，每个字段独立编码                    |
|         | • 每种编码都代表一个微命令且各字段编码含义单独定义，与其他字段无关。           |
|         | • 优点：可以缩短微指令字长                                |
|         | • 缺点：要通过译码电路之后再发出微命令，速度慢                      |
|         | • 分段原则                                        |
|         |         ○ 互斥性微命令组合在同一字段中，把相容性微命令组合在不同字段中      |
|         |         ○ 每个小段中包含的信息位不能太多，否则将增加译码电路的复杂性和译码时间  |
|         |         ○ 一般每个小段还要留出一个状态，表示本字段不发出任何微命令        |
| 字段间接编码法 | • 一个字段的某些微命令需由另一字段中的某些微命令解释                   |
|         | • 由于不是靠字段直接译码发出的微命令，因此称为字段间接编码                |
|         | • 优点：可进一步缩短微指令字长                              |
|         | • 缺点：削弱了微指令的并行能力                              |
#### 地址形成的方式
后继微地址的形成类型
- 直接由微指令的下地址字段指出。格式中设置一个下地址（断定方式）。
- 根据机器指令的操作码形成。机器指令取至IR后，微指令的地址由操作码经微地址形成部件形成。
- 增量计数器法（微地址连续）。根据各种标志决定微指令分支转移的地址
- 通过测试网络形成。由硬件直接产生微程序入口地址
#### 微指令的格式
- 水平型微指令
- 垂直型微指令
- 混合型微指令

- 水平型和垂直型对比

| 水平型              | 垂直型         |
| ------------------ | ------------- |
| 并行操作能力强，效率高，灵活性强 | 相反          |
| 执行一条指令的时间短       | 相反          |
| 微指令字位数较多，微程序较短   | 相反          |
| 用户难以掌握           | 与指令相似，用户好掌握 |
#### 动态微程序设计&毫微程序设计
- 动态微程序设计
	- 能根据用户的要求改变微程序，则其具有动态微程序设计功能。
	- 需要可写控制寄存器的支持。可采用EPROM。
- 毫微程序设计
	- 硬件不由微程序直接控制，而是通过存放在第二级控制存储器中的毫微程序来解释的
	- 这个第二级控制存储器就成为毫微存储器，直接控制硬件的就是毫微微指令
```ad-abstract
- 微程序入口地址是机器指令的操作码字段
- 控制存储器CM采用ROM组成，一条微指令存放在CM单元中；CM属于CPU的一部分
- 微指令计数器决定微指令执行顺序
- 字段直接编码法每个互斥类为一个字段，每个字段需要留出一个状态
- 微指令的编码方式中，直接编码方式效率最高
- 兼容性微命令是指可以同时产生，同时完成某些某操作的微命令

- 若指令系统中有n种机器指令，则控制存储器中的微程序数至少是n+2个

- 一个是公共的取值程序，一个是对应中断周期的微程序

- 水平型微指令和垂直线微指令的对比
```
# 指令的执行过程
## 指令周期的概述
- 指令周期: CPU从主存中取出并执行一条指令的时间
- 指令周期最多有4种机器周期：取指周期、间址周期、执行周期、中断周期（都有访问主存的操作）
- 分别对应标志触发器：FE、IND、EX、INT（“1”表示有效，如1-->FE表示有取值周期）
## 易混淆知识点
| 指令    | • CPU区分指令和数据的依据是指令周期的不同阶段（取指周期取指令，执行周期取数据）                     |
|-------|----------------------------------------------------------------|
|       | • 不同长度的指令，取指操作可能不同（如双字指令，三字指令和单字指令）；指令长度相同的情况下，指令的取值操作是相同的     |
|       | • 指令总是根据PC从主存中读出（无条件转移指令或中断返回指令也是如此，最终的结果还是根据PC从主存读出）          |
| 取值    | • 取值操作是控制器固有的功能，不需要操作码的控制                                      |
|       | • 取指操作是自动进行的，控制器不需要得到相应的指令                                     |
|       | • 取值周期简单来说是取指，即从主存中取出指令字                                       |
| 字长    | • 为了硬件设计方便，指令字长一般取存储字长的整数倍                                     |
|       | • 如果指令字长=存储字长的2倍，则取一条指令需要访存2次，取指周期是机器周期的2倍（📢指令字长和机器字长无任何关系！！） |
| 中断    | • CPU在每条指令执行结束前，都要发中断查询信号                                      |
|       | • CPU响应中断的时间是一条指令执行结束后                                         |
| 周期    | • 指令周期: CPU从主存中取出并执行一条指令的时间，一个指令周期由多个机器周期组成                    |
|       | • CPU周期/机器周期：一个机器周期包含若干时钟周期                                    |
|       | • 时钟周期/节拍/T周期: 计算机工作的最小时间周期, 是CPU操作的基本单位；一个时钟周期内控制信号不发生改变      |
|       | • 存取周期：连续启动两次独立的读/写操作所需要的最短时间                                  |
| 周期的关系 | • 机器周期通常由存取周期确定（因为存取周期时间最长）                                    |
|       | • 执行各条指令的机器周期数可变，各机器周期的长度可变                                    |
|       |         ○ 机器周期是指令执行中每步操作（如取指令，存储器读/写）所需要的时间                    |
|       |         ○ 每个机器周期内的节拍数可以不等，因此长度可变                               |
|       |         ○ 各种指令的功能不同，所以指令执行时所需的机器周期数可变                          |
|       | • 采用DMA方式传递数据，每传送一个数据就要占用存取周期                                  |
| 其他    | • 不采用Cache表明每次取指令都只是要访问内存一次                                    |
|       | • 不采用指令预取技术表明每个指令周期都需要取指令                                      |
## 不同指令的指令周期举例
|                                             |                                                                                                                                                 |
| ------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| 指令类型                                        | 指令周期的组成                                                                                                                                         |
| 无条件转移指令JMP X                                | - 指令周期 = 取指周期+执行周期<br>- PC被修改两次  = 取值周期结束PC自动加1  + 执行周期PC值修改为要调转到的地址                                                                            |
| 间接寻址的指令                                     | - 指令周期 = 取指周期+间址周期+执行周期<br>- 为了取操作数，需要先访问一次主存，取出有效地址--->取指周期<br>- 然后访问主存，取出操作数--->间址周期<br>- 间址周期结束时，CPU中MDR中的内容是操作数的有效地址EA                      |
| 当CPU采用中断方式  <br>实现主机和I/O设备的  <br>信息交换且有中断请求 | - 指令周期 = 取指周期+间址周期+执行周期+中断周期<br>- CPU在每条指令执行结束前，都要发中断查询信号<br>- 若有中断请求，则CPU进入中断响应阶段----->中断周期<br>- 📢中断周期进栈操作是将SP-1，计算机的堆栈都是向低地址增加，所有进栈操作减1而不是加1 |
## 指令周期的数据流
- 数据流：根据指令要求一次访问的数据序列
- 指令执行不同阶段，访问的数据序列不同
- 不同的指令，数据流也不同

### 取值周期
![1724241048290](https://github.com/user-attachments/assets/a77e7c9b-2367-4130-98a0-efe859dc6658)
- PC->MAR->地址总线->存储器
- CU->读命令->控制总线->存储器
- 主存->数据总线->MDR->IR
- CU发出控制信号->PC+1

### 间址周期
取操作数有效地址

![1724241255113](https://github.com/user-attachments/assets/acff6f27-ccf6-48aa-bd37-d0a593559e56)
### 执行周期
取操作数
### 中断周期
![1724241369103](https://github.com/user-attachments/assets/2dd8da45-df05-4833-b75f-6fafbf6cc944)
- CU控制将SP-1，SP->MAR->地址总线->存储器
- CU发出写命令->控制总线->存储器
- PC->MDR->数据总线->主存(程序断电存入存储器)
- CU（中断服务的入口地址）->PC
## 指令的执行方案
- 如何安排指令的执行步骤称为指令执行方案

|       |           |                                                                  |
| ----- | --------- | ---------------------------------------------------------------- |
|       | 特点        | 定义                                                               |
| 单指令周期 | 串行，相同执行时间 | - 每条指令都在固定的时钟周期内完成，指令之间串行执行<br>- 指令周期取决于执行时间最长的指令的执行时间           |
| 多指令周期 | 串行，不同执行时间 | - 指令之间串行执行<br>- 可以选用不同个数的时钟周期来完成不同指令的执行过程<br>- 指令需要几个周期就为其分配几个周期 |
| 流水线方案 | 并行        | - 力争在每个时间脉冲周期完成一条指令的执行过程（理想情况）<br>- 尽量让多条指令同时运行，但各自处在不同的执行步骤中    |
## 数据通路的概述
|         |                                                                                                                                                                                    |
| ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 数据通路的定义 | - 数据通路：数据在功能部件之间传送的路径，包括数据通路上流经的部件<br>- 它描述了信息从什么地方开始，中间经过哪个寄存器或多路开关，最后传送到哪个寄存器                                                                                                    |
| 数据通路的功能 | - 实现CPU内部的运算器与寄存器及寄存器之间的数据交换                                                                                                                                                       |
| 易混淆知识点  | - 数据通路是由控制部件控制，控制部件根据每条指令功能的不同生成对数据通路的控制信号<br>- 单总线数据通路将所有寄存器的输入输出端都连接在一条公共通路上，一个时钟内只允许一次操作，无法完成指令的所有操作<br>- CPU的读/写控制信号线决定了是从存储器读还是向存储器写<br>- 内部总线是指同一部件之间的线，系统总线是同一台计算机系统各部件之间的线 |
|         |                                                                                                                                                                                    |
## 数据通路的基本情况
## 数据通路的基本情况
|              |                                                                                                                              |
| ------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| CPU内部单总线方式   | 【定义】将所有寄存器的输入端与输出端都连接到一条公共通路上<br><br>【特点】结构比较简单，数据传输存在较多的冲突现象，性能较低                                                           |
| CPU内部三/多总线方式 | 【定义】将所有寄存器的输入端与输出端都连接到多条公共通路上<br><br>【特点】相较单总线结构，效率提高                                                                        |
| 专用数据通路方式     | 【定义】根据指令执行过程中的数据和地址的流动方向安排连接线路<br><br>【特点】避免使用共享的总线，性能较好，但硬件总量大                                                              |
| 各个方式的对比      | ==采用CPU内部总线的数据通路(单总线和多总线)的特点==\|结构简单，实现容易，性能较低，存在较多的冲突现象\|<br>==不采用CPU内部总线的数据通路(专用数据通路)的特点==\|结构复杂，硬件量大，不易实现，性能高，基本不存在数据冲突\| |

# 控制器的功能和工作原理
## 控制器的结构和功能
### 结构
![1719397784183](https://github.com/user-attachments/assets/50b7073c-b7fc-49c3-8b4e-dea7cd247650)
### 连接关系
| 运算器            | • 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据 |
|----------------|----------------------------------|
| 输入设备和输出设备      | • 输入设备和输出设备通过接口电路与总线相连接          |
| 内存储器、输入设备和输出设备 | • 内存储器、输入设备和输出设备从地址总线接收地址信息      |
|                | • 从控制总线得到控制信号，通过数据总线与其他部件传送数据    |
| 控制器部件          | • 控制器部件从数据总线接受指令信息               |
|                | • 从运算器部件接受指令转移地址，送出指令地址到地址总线     |
|                | • 还要向系统中的部件提供它们运行所需要的控制信号        |
**根据控制器产⽣微操作信号的⽅式的不同，控制器可以分为硬布线控制器和微程序控制器**
## 硬布线控制器和微程序控制器
### 硬布线控制器(RISC)
#### 工作原理
需要结合各微操作的节拍安排，综合分析，写出逻辑表达式，再设计逻辑电路图
#### 特点
- 采用硬件电路，速度快
- 设计难度大，成本高，不易扩展
- 时序系统复杂
#### 基本原理
- 根据指令的要求、当前的时序及外部和内部的状态，按时间顺序发送一系列微操作控制信号
- 是由复杂的组合逻辑门电路和一些触发器构成，又称组合逻辑控制器
#### 硬布线控制单元图
CU的输入信号来源
- 经指令编译器译码产生的
- 时序系统产生的机器周期信号和节拍信号
- 来自执行单元的反馈信号，即标志

微操作控制信号的形成主要与指令译码信号和时钟信号有关

![Pasted image 20240626183839](https://github.com/user-attachments/assets/9ea1fb8d-bc09-4a46-8871-f8ce5c987f60)
#### 硬布线控制器的时序系统及微操作
- 时钟周期：用时钟信号控制节拍发生器，可以产生节拍，每个节拍的宽度正好对应一个时钟周期
- 机器周期：可以视为所有指令执行过程中的一个基准时间
- 指令周期：CPU从主存中取出并执行一条指令的时间称为指令周期
- 微操作命令分析：控制单元发出各种操作命令序列的功能
#### CPU的控制方式
| 同步控制方式 | • 系统有一个统一的时钟，所有的控制信号都来源于这个统一的时钟信号        |
|--------|------------------------------------------|
|        | • 通常以最长的微操作序列和最繁琐的微操作作为标准                |
|        | • 采取完全统一的、具有相同时间间隔和相同数目的节拍作为机器周期来运行不同的指令 |
|        | • 优点：控制电路简单                              |
|        | • 缺点：运行速度慢                               |
| 异步控制方式 | • 不存在基准时标信号，各部件按照自身固有速度工作，通过应答方式进行联络     |
|        | • 优点：运行速度快                               |
|        | • 缺点：控制电路较为复杂                            |
| 联合控制方式 | • 介于同步、异步之间的一种折中                         |
|        | • 对大部分采用同步控制，小部分采用异步控制                   |
```ad-abstract
- 微操作控制信号的形成主要与指令译码信号和时钟信号有关（见CU的输入信号来源）
- 微处理器与微程序控制器没有必然联系，微处理器是相对于一些大型处理器而言的
- 微机的CPU都是微处理器

- 各种“微”的关系
	- 每条机器指令编写成一个微程序
	- 每个微程序包含若干微指令
	- 每条微指令对应一个或几个微操作命令
	- 机器指令---->微程序---->微指令----->微操作命令
```
### 微程序控制器(CISC CPU)
#### 工作原理
按照节拍的安排，顺序执行微操作
#### 特点
- 速度较慢（主要是因为增加了从CM读取微指令的时间）
- 灵活性高，易扩充修改
- 时序系统简单
#### 基本原理
- 采用存储逻辑实现，即把微操作信号代码化
#### 基本思想
- 将每条机器指令编写成一个微程序，每个微程序包含若干微指令，每条微指令对应一个或几个微操作命令
- 机器指令---->微程序---->微指令----->微操作命令
- 这些微程序可以存到一个控制存储器中，用寻址用户程序机器指令的办法来寻址每个微程序中微指令
#### 基本概念
| 微命令与微操作    | • 微操作是计算机中最基本、不可再分解的操作；微命令执行的操作叫做微操作  |
|------------|---------------------------------------|
|            | • 微命令将控制部件向执行部件发出的各种控制命令；是构成控制序列的最小单位 |
| 微指令和微周期    | • 微指令是若干微命令的集合                        |
|            | • 微地址存放微指令的控制存储器的单元地址                 |
|            | • 微周期指的是从控制存储器中读取一条微指令并执行相应的微操作所需的时间  |
|            | • 微指令的两个组成部分：微操作码字段和微地址码字段            |
| 主存储器与控制存储器 | • 主存用于存放程序和数据，在CPU外部，用RAM实现；          |
|            | • CM用于存放微程序，在CPU内部，用ROM实现。            |
| 程序与微程序     | • 程序是指令的有序集合，用于完成特定的功能；               |
|            | • 微程序是微指令的有序集合，一条指令的功能由一段微程序实现。       |
| 微程序和机器指令   | • 一般来说，一条机器指令对应一个微程序                  |
#### 寄存器分类
| 地址寄存器  | 存放主存的读写地址        |
|--------|------------------|
| 微地址寄存器 | 存放控制存储器的读写微指令的地址 |
| 指令寄存器  | 存放从主存中读出的指令      |
| 微指令寄存器 | 存放从控制存储器中读出的微指令  |
#### 基本组成
控制存储器：核心部件，用于存放各指令对应的微程序，控制存储器可用ROM构成

微指令寄存器：存放从CM中取出的微指令，位数与微指令字长相等

微地址形成部件：用于产生初始微地址和后继微地址，以保证微指令的连续执行

微地址寄存器：接受微地址形成部件送来的微地址，为在CM中读取微指令做准备

![Pasted image 20240626185011](https://github.com/user-attachments/assets/842146fc-dda9-446a-9d53-ba13e0f39629)
#### 工作过程
1. 执行取微指令公共操作
2. 由机器指令的操作码字段通过微地址形成部件产生该及其指令所对应的微程序的入口地址，并送入CMAR【微程序入口地址是机器指令的操作码字段】
3. 从CM中逐条取出对应的微指令并执行
4. 执行完对应于一条机器指令的一个微程序后，又回到取指微程序的入口地址，继续第一步
#### 编码方式与控制方式
| 目的      | 保证速度的情况下尽量缩短指令字长                              |
|---------|-----------------------------------------------|
| 直接编码方式  | • 无需进行译码，微指令的微命令字段中的每一位都代表一个微命令（选用“1”，不选用“0”） |
|         | • 优点：简单、直观、执行速度快，操作并行性好                       |
|         | • 缺点：微指令字长过长，n个微指令就要求微指令的操作字段有n位，造成控制存储器容量极大  |
| 字段直接编码法 | • 将微命令字段分成若干小字段，将互斥性微命令组合在同一字段中               |
|         | • 把相容性微命令组合在不同字段中，每个字段独立编码                    |
|         | • 每种编码都代表一个微命令且各字段编码含义单独定义，与其他字段无关。           |
|         | • 优点：可以缩短微指令字长                                |
|         | • 缺点：要通过译码电路之后再发出微命令，速度慢                      |
|         | • 分段原则                                        |
|         |         ○ 互斥性微命令组合在同一字段中，把相容性微命令组合在不同字段中      |
|         |         ○ 每个小段中包含的信息位不能太多，否则将增加译码电路的复杂性和译码时间  |
|         |         ○ 一般每个小段还要留出一个状态，表示本字段不发出任何微命令        |
| 字段间接编码法 | • 一个字段的某些微命令需由另一字段中的某些微命令解释                   |
|         | • 由于不是靠字段直接译码发出的微命令，因此称为字段间接编码                |
|         | • 优点：可进一步缩短微指令字长                              |
|         | • 缺点：削弱了微指令的并行能力                              |
#### 地址形成的方式
后继微地址的形成类型
- 直接由微指令的下地址字段指出。格式中设置一个下地址（断定方式）。
- 根据机器指令的操作码形成。机器指令取至IR后，微指令的地址由操作码经微地址形成部件形成。
- 增量计数器法（微地址连续）。根据各种标志决定微指令分支转移的地址
- 通过测试网络形成。由硬件直接产生微程序入口地址
#### 微指令的格式
- 水平型微指令
- 垂直型微指令
- 混合型微指令

- 水平型和垂直型对比

| 水平型              | 垂直型         |
| ------------------ | ------------- |
| 并行操作能力强，效率高，灵活性强 | 相反          |
| 执行一条指令的时间短       | 相反          |
| 微指令字位数较多，微程序较短   | 相反          |
| 用户难以掌握           | 与指令相似，用户好掌握 |
#### 动态微程序设计&毫微程序设计
- 动态微程序设计
	- 能根据用户的要求改变微程序，则其具有动态微程序设计功能。
	- 需要可写控制寄存器的支持。可采用EPROM。
- 毫微程序设计
	- 硬件不由微程序直接控制，而是通过存放在第二级控制存储器中的毫微程序来解释的
	- 这个第二级控制存储器就成为毫微存储器，直接控制硬件的就是毫微微指令
```ad-abstract
- 微程序入口地址是机器指令的操作码字段
- 控制存储器CM采用ROM组成，一条微指令存放在CM单元中；CM属于CPU的一部分
- 微指令计数器决定微指令执行顺序
- 字段直接编码法每个互斥类为一个字段，每个字段需要留出一个状态
- 微指令的编码方式中，直接编码方式效率最高
- 兼容性微命令是指可以同时产生，同时完成某些某操作的微命令

- 若指令系统中有n种机器指令，则控制存储器中的微程序数至少是n+2个

- 一个是公共的取值程序，一个是对应中断周期的微程序

- 水平型微指令和垂直线微指令的对比
```
# 异常和中断控制
## 异常(内中断)
### 基本概念
- 由CPU内部产生的意外事件
- 是CPU执行一条命令时，由CPU在其内部检测到的、与正在执行指令相关的同步事件
- 故障和自陷为异常
- 终止异常和外中断属于硬件中断
### 分类
| 故障 | • 在引起故障的指令启动之后、执行结束前被检测到的异常事件                   |
|----|-------------------------------------------------|
| 自陷 | • 也称陷阱或陷入，是预先安排的一种“异常事件”，就像预先设置好的“陷阱”一样         |
| 终止 | • 若在执行指令的过程中发生了使计算机无法继续执行的硬件故障，那么程序将无法继续执行，只能终止 |
### 举例
| 故障  | • 指令译码时，出现“非法操作码”            |
| --- | ---------------------------- |
|     | • 取数据时，发生“缺段”或“缺页”           |
|     | • 除数为零                       |
|     | • 地址越界                       |
| 自陷  | • x86机器中，用于程序调试“断点设置”和单步跟踪功能 |
|     | • 系统调用指令                     |
|     | • 条件自陷指令                     |
| 终止  | • 控制器出错                      |
|     | • 存储器校验错                     |
|     | • 调出中断服务程序来重启系统              |
|     |                              |
### 执行时间
- CPU在执行指令时会检查是否有异常发生
### 不同点
- 缺页”或“溢出”等异常事件是由特定指令在执行过程中产生的
- 异常的检测由CPU自身完成，不必通过外部的某个信号通知CPU
## 中断（外中断）
### 基本概念
- 由来自CPU外部的设备发出的中断请求（常用于输入输出）
- 典型的由外部设备触发的、与当前正在执行的指令无关的异步事件
- 外部I/O设备通过特定的中断请求信号线向CPU提出中断请求
- CPU每执行完一条指令就检查中断请求信号线，若检测到中断请求，则进入中断响应期
- 外部中断都是在一条指令执行完成后（中断周期）才被检测并处理的
### 分类
| 可屏蔽中断  | • 通过可屏蔽中断请求线INTR向CPU发出的中断请求                       |
|--------|---------------------------------------------------|
|        | • CPU可以通过在中断控制器中设置相应的屏蔽字来屏蔽或不屏蔽它，被屏蔽的中断信号将不被送到CPU |
| 不可屏蔽中断 | • 通过不可屏蔽中断请求线NMI向CPU发出的中断请求                       |
|        | • 通常是非常紧急的硬件故障，如电源掉电等。                            |
### 举例
- Cache缺失
- I/O中断：键盘输入，打印机缺纸
- 时钟中断
- I/O中断请求
### 执行时间
 - 每个指令周期末尾，CPU都会检查是否有外中断信号需要处理
### 不同点
- 中断不与任何指令相关联，也不阻止任何指令的完成
## 异常和中断响应过程
- 响应过程不可被打断，整个中断处理过程是软/硬件协同实现的
- 单中断（即不能有中断嵌套）执行流程：保护现场---中断事件处理---恢复现场---开中断---中断返回
# 指令流水线
## 常考知识点
1. 流水CPU是一种非常经济而实用的时间并行技术
2. m段流水线的CPU吞吐能力 = m个并行部件的CPU吞吐能力
3. 数据通路由控制部件控制，所以包含生成控制信号的控制部件
4. 指令流水线的每个流水段时间单位为时钟周期
5. 理想情况下，执行一条指令所需的时钟周期数CPI=1的有：单周期CPU和基本流水线CPU
6. 3种相关导致指令流水线阻塞：结构相关/资源相关，数据相关，控制相关
## 流水线的时间计算
- 设一条指令有3条流水段，每段平均时间为t，度为1
单流水线处理机执行12条指令的时间 =  3t+(12−1)t= 一条指令所需时间+(指令条数-1)\*时间最长的指令的一段

- 2. 设一条指令有3条流水段，每段平均时间为t，度为4
单流水线处理机执行20条指令的时间 =   3t+(20−4)/4 t

📢度为4说明是超标量流水线处理机，一次可以发送4条指令

$$吞吐量=\frac{指令条数}{流水线执行时间}$$

$$流水线的加速比=\frac{不使用流水线的所用时间}{使用流水线所用的时间}$$
## 流水线的基本概念
### 如何提高处理机的并行性？
时间上的并行技术
- 将一个任务拆分成几个不同的子阶段
- 每个阶段在不同的功能部件上并行执行，即流水线技术

2.空间上的并行技术
- 在一个处理机内设置多个执行相同任务的功能部件
- 并让这些功能部件并行工作，这样的处理机称为超标量处理机
### 指令流水定义
- 将指令执行过程的各阶段视为相应的流水段，则指令的执行过程就构成了一条指令流水
### 指令流水举例
- 假设一条指令的执行有5条流水段
```ad-info
取指（IF）：从IR或者Cache中取指令

译码/读寄存器（ID）：操作控制器对指令进行译码，同时从寄存器堆中取操作数

执行/计算地址（EX）：执行运算操作或计算地址

访存（MEN）：对存储器进行读写操作

写回（WB）：将指令执行结果写回寄存器堆
```

![Pasted image 20240626202519](https://github.com/user-attachments/assets/a1060929-d005-4ede-989e-92bed6dd69e6)
- 设用时最长的流水段用时X秒(如200ns)，总执行时间为y秒(如700ns)，系统由N条指令，度为1
- 则单处理机用时为y × N，流水线处理机用时为y+(N-1)×X
- 不能缩短单条指令的执行时间，但对于整个程序来说，执行效率得到大幅提升
### 指令集应有的特点
- 指令长度尽量一致。有利于简化取指和指令译码操作
- 指令格式尽量规整。尽量保证源寄存器的位置相同，有利于在指令未知时就可取存寄存器操作数
- 采用Load/Store指令。把Load/Store指令的地址计算和运算指令的执行步骤规整到同一个周期中，有利于减少操作步骤
- 数据和指令在存储器中“对齐”存放。这样有利于减少访存次数使所需数据在一个流水段内就可以从存储器中找到
### 流水线的表示方法
- 采用时空图描述流水线的执行情况

![Pasted image 20240626202759](https://github.com/user-attachments/assets/19ab1c04-ed30-4cf0-a552-f5b352a4de14)
## 流水线的冒险于处理
### 结构冒险
不同部件同一时刻争用同一功能部件形成的冲突，资源冲突
#### 解决方法
1. 前一指令访存，后一条相关指令暂停一个周期。
2. 设置多个独立部件。
### 数据冒险
RAW（后读）后面用到前面结果，前面结果还没产生
#### 解决方法
1. 延迟执行相关指令
2. 采用旁路转发技术
3. load-use数据冒险地处理，在指令前加入nop指令
### 控制冒险
指令通常顺序执行。遇到改变指令执行顺序地情况，造成断流，也称控制冲突
#### 解决方法
- 插入nop指令
- 分支预测
# 多处理机的基本概念
## 常考点
1. SISD/SIMD/MIMD的区分：总得来说就是：控制部件的多少决定是SI还是MI，处理数据单元的多少决定是SD还是MD
2. 多处理机，超程序技术，双核技术

|                  |                                                                                                                                                                                                                               |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 多处理机             | - 常规的多处理机属于MIMD<br>- 真正的并行执行：在多核处理机中，必须采用多线程执行，使每个核在同一时刻都有线程在执行<br>- 时间并行：流水线技术<br>- 空间并行：硬件资源(如控制部件)的重复，空间并行导致SIMD和MIMD的产生                                                                                                   |
| 超程序技术  <br>【虚双核】 | - 在一个CPU中，提供两套线程处理单元，让单个处理器实现线程级并行<br>- 在CPU内部仅复制必要的线程资源来让两个线程同时运行<br>- 共享CPU的高速缓存和功能部件<br>- 能并行执行两个线程，模拟实体双核心<br>- 含有超程序技术的CPU需要芯片组和应用软件的支持才能发挥技术优势<br>- 当两个线程同时需要某个共享资源时，一个线程必须挂起等待                                         |
| 双核技术  <br>【实双核】  | - 双核是指将两个CPU核心集成到一个封装中<br>- 核心又叫内核，是CPU的重要组成部分<br><br>- 主板上有两个CPU属于多处理机<br><br>- 多核CPU的核心通常是对称的<br>- 多核CPU公用一组内存，数据共享<br>- 各个核可以有自己的Cache也可以共享Cache<br>- 只有支持多线程的并行处理程序才能同时在多个核心上运行<br>- 多任务系统/多道程序系统，可以运行在单核CPU上，宏观上并行，微观上串行 |
## SISD，SIMD，MIMD的基本概念
- 基于指令流的数量和数据流的数量，将计算机体系结构分为SISD，SIMD，MISD和MIMD
### 单指令流单数据流结构（SISD）Single instruction, single data
- 串行计算机结构
- 通常只包含一个处理器和一个存储器
- 有些使用流水线的方式，所以有时会设置多个功能部件，并采用多模块交叉方式组织存储器
### 单指令流多数据流结构（SIMD）Single instruction, multiple data
- 一个指令流同时对多个数据流进行处理，称为数据级并行技术
- 由一个指令控制部件、多个处理单元组成
- 每个处理单元虽然执行的都是同一条指令,但每个单元都有自己的地址寄存器，就有了不同的数据地址
- 一个顺序应用程序被编译之后,可能按照SISD组织并运行于串行硬件上，也可能按SIMD组织并运行于并行硬件上
- for循环效率高，但switch或case时效率低
- 向量处理器也是SIMD的变体，是一种实现了直接操作一维数组（向量）指令集的CPU
### 多指令流单数据流结构（MISD）Multiple instruction, single data
- 同时执行多条指令，处理同一个数据
- 实际上不存在这样的计算机
### 多指令流多数据流结构（MIMD）Multiple instruction, multiple data
- 同时执行多条指令，处理多个不同的数据

- 分为多计算机系统和多处理器系统

| 多计算机系统 | • 每个计算机节点都具有各自的私有存储器，并且具有独立的主存地址空间           |
|--------|----------------------------------------------|
|        | • 不能通过存取指令来访问不同节点的私有存储器                      |
|        | • 而要通过消息传递进行数据传送，也称为消息传递MIMD                 |
| 多处理器系统 | • 共享存储多处理器（SMP）系统的简称                         |
|        | • 它具有共享的单一地址空间，通过访存指令来访问系统中的所有存储器，也称共享存储MIMD |
### 联系与区别
- SIMD和MIMD是两种并行计算模式（多数据就是并行）
- SIMD是一种数据级并行模式【数据级别】
- MIMD是一种并行程度更高的线程级并行或线程级以上并行计算模式【线程级别】
