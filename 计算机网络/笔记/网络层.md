# 网络层概述
- 网络层的主要任务是实现网络互联，进而实现数据包在各网络之间的传输
- 要实现网络层任务，需要解决以下问题：
	- 网络层向运输层提供怎么样的服务？【向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务】
	- 网络层寻址问题
	- 路由选择问题 
# 网络层的主要功能
## 异构网络功能
- 异构网络：数据链路层和物理层均不同的网络
- 网络层的任务之一就是使异构网络实现互联
- 网络互联通常是指用路由器进行网络互联和路由选择
- 使用中继系统连接网络

| 物理层     | 数据链路层  | 网络层 | 网络层以上 |
| ------- | ------ | --- | ----- |
| 转发器，集线器 | 网桥，交换机 | 路由器 | 网     |
## 路由选择与分组转发
- 路由选择（确定那一条路径）
- 分组转发（当一个分组到达时所采取的动作）
## 拥塞控制
### 拥塞
- 在通信子网中，因出现过量的分组而引起网络性能下降的现象
- 此时所有节点都来不及接受分组，而要丢弃大量分组
### 判断是否拥塞的方法
- 观察网络吞吐量与网络负载的关系
- 随着通信子网负载的增加，吞吐量反而降低，即可能发生拥塞
- 轻度拥塞--->拥塞---->死锁
### 拥塞控制的方法
- 开环控制【静态】：事先考虑可能发生拥塞的情况，一旦系统启动，就不修改
- 闭环控制【动态】：采用检测网络监视哪里发生了拥塞，动态调整网络系统运行
# SDN的基本概念
- 软件定义网络SDN采用集中式的控制层面和分布式的数据层面来控制网络
- **北向接口**：SDN提供的编程接口
- **南向接口**：SDN控制器和转发设备建立双向会话的接口（使用南向接口协议，如openflow)
- **东西向接口**：SDN控制器集群内部控制器之间的通信接口
# 网络层设备
## 冲突域与广播域
- **域**：冲突或广播发生在其中并传播的区域
- **冲突域**：连接到同一物理介质上的所有节点的集合，这些结点之前存在介质争用的现象【OSI第一层】
- **广播域**：接受同样广播信息的节点集合【OSI第二层概念】
- 局域网LAN特指使用路由器分割的网络，也就是广播域
## 路由器的组成和功能
- 路由器是一种具有多个输入/输出端口的专用计算机
- 路由器主要实现物理层，数据链路层，网络层的功能
- 路由器是网络层设备
### 路由器的任务
- 连接异构网络并完成路由转发
### 路由器的功能
- 分组转发
	- 处理通过路由器的数据流
- 路由计算
	- 通过和其他路由器进行路由协议的交互，完成路由表的计算
### 路由器的组成
![1725519442010](https://github.com/user-attachments/assets/29c4f108-47e2-4f9e-b4df-7c5805749780)

- **路由选择部分**
	-  路由选择处理机 + 路由选择协议 + 路由表
	- 也叫控制部分，核心是路由选择处理机
	- 任务是根据所选定的路由选择协议构造出路由表
	- 同时不断更新路由信息和维护路由表
- **分组转发部分**
- 交换结构(本身就是一个网络) + 一组输入端口 + 一组输出端口
	- 三种交换方式
		- 通过存储器
		- 通过总线
		- 通过互联网
### 路由表域路由转发
- 路由表是根据路由选择算法得出的，主要用途是路由选择
- 路由表的组成 = 目的网络的IP地址 + 子网掩码 + 下一跳IP地址 + 接口

![1725519474151](https://github.com/user-attachments/assets/ff11f274-0173-4129-adc4-dbfb616d17f5)
- 路由表总是用软件实现，转发表可以用软件也可以用硬件实现
- 路由表不等于转发表，分组的实际转发是靠直接查找转发表，而不是直接查找路由表
- 路由表中默认路由的目的地址和子网掩码都是0.0.0.0
# IP地址的基本知识
## IP地址的定义
![Pasted image 20240527191104](https://github.com/user-attachments/assets/a6e1afb3-e964-40bd-b093-05f56e985a05)

![Pasted image 20240527191129](https://github.com/user-attachments/assets/606ca356-8056-4dc6-ac4e-e42a73f2ea11)

![Pasted image 20240527191137](https://github.com/user-attachments/assets/1c0d03a2-ee4e-481c-8561-8601bbaf9e0b)
- MAC 的作用则是实现「直连」的两个设备之间通信，而 IP 则负责在「没有直连」的两个网络之间进行通信传输
- 源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化
- IPV4地址由 32 位正整数来表示，IP 地址在计算机是以二进制的方式处理的
- IP地址最大值 = 2^32 = 43亿左右
- IP 地址并不是根据主机台数来配置的，而是以网卡。像服务器、路由器等设备都是有 2 个以上的网卡，也就是它们会有 2 个以上的 IP 地址
## 分类编址的IPV4地址
### 分类
![Pasted image 20240527191352](https://github.com/user-attachments/assets/111c4438-843f-4b63-be6c-467b03aff7d0)
```ad-info
ABC类地址主要由网络号和主机号组成

- 网络号标志主机/路由器所连接到的网络
- 主机号标志主机/路由器
```
### 环回测试网络地址
- 127.x.x.x是环回自检地址，不指派
- 最小的环回地址：127.0.0.1
- 最大的环回地址：127.255.255.254
### 最大可用网络数
- A类最大可用网络数= $2^{网络号}-2$
- BC类最大可用网络数= $2^{网络号}$
- 网络号为0或127不指派
### 最大可用主机数
- 最大可用主机数= $2^{主机号}-2$
- 主机号全为 1 的地址是广播地址【255.255.255.255只能作为目的地址使用】
- 主机号全为 0 的地址是网络本身【0.0.0.0只能作为源地址使用】
### DE类地址
- D 类和 E 类地址没有主机号
- 不可用于主机 IP
- D 类常被用于多播
- E 类是预留的分类，暂时未使用
### IP分类的有缺点
- 优点
	- 简单明了、选路（基于网络地址）简单
- 缺点
	- 同一网络下没有地址层次，缺少地址层次的灵活性
	- C类地址254个太少了，B类地址65534个又太多了，不能很好的与显示网络匹配
	- 上述两个缺点都可用【CIDR】解决
```ad-info
A类地址网络号为左起第一个字节，B类为2个字节，C类为3个字节

根据第一个十进制判断网络类别【<127为A类】【128～191为B类】【192～223为C类】
```
# 划分子网的IPV4地址
![Pasted image 20240527192432](https://github.com/user-attachments/assets/442a90f1-5572-44a6-bcd1-027bd6433c7c)
## 为什么要划分子网
- 两级IP地址分类的地址空间流动率有时很低，用子网划分的方法来改善这个问题
## 划分子网的好处
- 增加子网的数量--->减少广播域的大小--->减少了主机的数量--->提高了IP地址的利用率
- 不增加网络的数量
![Pasted image 20240527192632](https://github.com/user-attachments/assets/16bc291a-e858-432c-b47e-59a3f30e5cfc)
## 如何获得网络地址
将子网掩码和 IP 地址按位计算 AND，就可得到网络号
## 默认子网掩码
- A类：255.0.0.0
- B类：255.255.0.0
- C类：255.255.255.0

![Pasted image 20240527192804](https://github.com/user-attachments/assets/67046322-5637-4915-b2f7-73e6c23eef4f)
## 怎么进行子网划分
- 假设对 C 类地址进行子网划分
- 网络地址 218.75.230.0，使用子网掩码 255.255.255.192 对其进行子网划分
- C 类地址中前 24 位是网络号，最后 8 位是主机号
- 根据子网掩码可知从 8 位主机号中借用 2 位作为子网号
- 由于子网网络地址被划分成 2 位，那么子网地址就有 4 个，分别是 00、01、10、11
- 划分后的 4 个子网如上图所示
## 无分类编址的IPV4地址[CIDR]
### 为什么引入CIDR
CIDR消除了传统的A类，B类和C类地址，以及划分子网的概念
### CIDR的作用
- CIDR是一种归并技术，可以把小的网络汇聚成大的超网
- CIDR可以更加有效地分配IPV4的地址空间，并且可以在新的IPV6使用之前允许因特网的规模继续增长
### CIDR的细节
CIDR的表示形式，最小地址，最大地址，地址数量，聚合网络数量，地址掩码

![Pasted image 20240527193308](https://github.com/user-attachments/assets/faf4dc05-d5dc-44b4-b4fa-e38bba38a117)
### 路由聚合是什么
- 为了减小路由表的消耗，用路由聚合来聚合网络地址
- 网络前缀越长，地址块越小，路由越具体
- 最长前缀匹配：有多条路由可选的时候，选择网络前缀最长的那条

![Pasted image 20240527193512](https://github.com/user-attachments/assets/56ad7d09-0902-4176-bfc3-c276337798de)

### IPV4地址的应用规划
#### 定长的子网掩码
- 使用同一个子网掩码来划分子网
- 子网划分不灵活只能划分出 $2^n$ 个子网
- 每个子网所分配的IP地址数量相同，容易造成IP地址浪费

![1725519730235](https://github.com/user-attachments/assets/69dd68e4-1927-48f5-ab67-457387151a7a)

#### 变长的子网掩码
- 使用不同的子网掩码来划分子网
- 子网划分方式灵活：可以按需分配
- 每个子网所分配的IP地址数量可以不同，尽可能减少对IP地址的浪费

![1725519760092](https://github.com/user-attachments/assets/edad93c3-4804-460d-b233-c838f8d87056)

## IP数据报的发送和转发过程
### 主机发送IP数据报
- 判断目的主机是否与自己在同一个网络
	- 若在同一个网络，直接交付
	- 若不在同一个网络，数据间接交付，传输给主机所在网络的默认网关（路由器），由默认网关帮忙转发
## 路由器转发IP数据报
- 检查IP数据报首部是否出错
	- 若出错，则直接丢弃该IP数据报并通告源主机
	- 若没有出错，则进行转发
根据IP数据报的目的地址在路由表中查找匹配的条目

![Pasted image 20240527195642](https://github.com/user-attachments/assets/28e38a46-ec72-4934-b3cd-99493a788efa)
## 静态路由配置及其可能产生的路由环路问题
### 静态路由配置
![1725519840030](https://github.com/user-attachments/assets/094cff98-0f75-4ae7-b322-6ec08dc296ea)

### 默认路由特定主机路由
![1725519861051](https://github.com/user-attachments/assets/bb8c4a99-faa3-461b-a048-afc66d79eb87)

### 静态路由配置错误导致路由环路
![1725519875251](https://github.com/user-attachments/assets/84299544-2d8f-4a62-9e6a-9bfd894a6877)
- 为了防止IP数据报在路由环路中永久兜圈，在IP数据报首部设有生存时间TTL字段
- IP数据报进入路由器后，TTL字段的值减1。
- 若TTL的值不等于0，则被路由器转发，否则被丢弃

### 聚合不存在的网络导致路由环路
![1725519933672](https://github.com/user-attachments/assets/0bf58673-fa86-473d-b00a-fdfb73f0a384)

用黑洞路由条目配置解决
### 网络故障而导致的路由环路
![1725519967729](https://github.com/user-attachments/assets/a8ce1aa6-f2df-45f3-9215-52383a8b2ab4)

- 用黑洞路由条目配置解决该问题
- 如果故障消失了，会暂时把黑洞路由条目设置为失效
# IPV6
![1725519985257](https://github.com/user-attachments/assets/7ab934c5-3a7e-453b-8b57-2dc00f29bc20)
## IPv6 地址的标识方法
- IPv6 地址长度是 128 位，是以每 16 位作为一组
- 每组用冒号 「:」 隔开。
- 如果出现连续的 0 时还可以将这些 0 省略，并用两个冒号 「::」隔开
- 但是，一个 IP 地址中只允许出现一次两个连续的冒号

![Pasted image 20240527200342](https://github.com/user-attachments/assets/4d595afb-3a50-43cd-b6a4-7f3f1fc84be4)
## IPv6 地址的结构
- 单播地址，用于一对一的通信
- 组播地址，用于一对多的通信
- 任播地址，用于通信最近的节点，最近的节点是由路由协议决定

## IPv6 的亮点
- IPv6 可自动配置【即插即用】
- IPv6 首部长度采用固定的值 40 字节，去掉了校验和
- IPv6安全性提高了

## IPv6 相比 IPv4 的首部改进
- 取消了首部校验和字段
	- 因为在数据链路层和传输层都会校验，因此 IPv6 直接取消了 IP 的校验
- 取消了分片/重新组装相关字段
	- 分片与重组是耗时的过程，IPv6 不允许在中间路由器进行分片与重组
	- 这种操作只能在源与目标主机，这将大大提高了路由器转发的速度
- 取消选项字段
	- 选项字段不再是标准 IP 首部的一部分了
	- 但它并没有消失
	- 而是可能出现在 IPv6 首部中的「下一个首部」指出的位置上
	- 删除该选项字段使的 IPv6 的首部成为固定长度的 40 字节
# IPV4首部
![Pasted image 20240527200601](https://github.com/user-attachments/assets/7194d93f-c84e-4e97-a084-47cc70d6fd18)
## 首部内容
```ad-abstract
- 首部长度，总长度，片偏移的基本单位分别为4B，1B，8B
```
![1725520074889](https://github.com/user-attachments/assets/c4be934c-9e57-4d73-b3c5-f9771b27e610)

## IPV4分片
- 以太网MTU【最大传输单元】不超过1500
- DF=1时，分组的长度又超过MTU时，丢弃该分组，并用ICMP差错报文向源主机报告
- MF=1，表示接收到的分片不是最后一个分片
-  所有片中的有效数据核载都是8的倍数【偏移值的单位是8B】
- 在目的主机中对分片后的数据报重组

![1725520114920](https://github.com/user-attachments/assets/9e35e642-2003-4444-a370-de6d171b53a8)

![1725520148233](https://github.com/user-attachments/assets/69f37b18-c142-44b8-b133-763a2e8ad4b1)
# 路由选择协议概述
## 静态路由选择&动态路由选择
![1725520188001](https://github.com/user-attachments/assets/a17c1498-e7ba-4af9-a5b9-669d8419df52)

## 路由选择的主要特点
- 自适应 - 动态路由选择，能较好地适应网络状态的变化
- 分布式 - 路由器之间交换路由信息
- 分层次 - 将整个因特网划分为许多较小的自治系统
## 分层次的路由选择协议
![1725520837923](https://github.com/user-attachments/assets/3de52ac9-57d6-46c0-86f1-8e3a405820ab)

## 路由选择协议汇总

![1725520853555](https://github.com/user-attachments/assets/23b12a04-e993-4c00-acc7-b0150d911436)
## 三种路由协议的比较

|      | RIP                                      | OSPF                                         | BGP                                            |
| ---- | ---------------------------------------- | -------------------------------------------- | ---------------------------------------------- |
| 类型   | 内部                                       | 内部                                           | 外部                                             |
| 路由算法 | 距离-向量                                    | 链路状态                                         | 路径-向量                                          |
| 传递协议 | UDP，应用层协议                                | IP，网络层协议                                     | TCP，应用层协议                                      |
| 路径选择 | 跳数最少                                     | 代价最低                                         | 较好，非最佳                                         |
| 交换节点 | 和本节点相邻                                   | 所有                                           | 和本节点相邻                                         |
| 交换内容 | 当前本路由器知道的全部信息，即自己的路由表  <br>RIP不知道全网的拓扑结构 | 与本路由相邻的所有路由器的链路状态  <br>任何一个路由器都知道自己所在区域的拓扑结构 | \| 首次  \| 整个路由表  \|<br>\| 非首次 \| 有变化的部分 \|<br> |
## RIP
### 基本概念
![1725520889993](https://github.com/user-attachments/assets/0842da84-8871-43c5-9e60-0e932bc15af0)

### 工作原理
![1725520907334](https://github.com/user-attachments/assets/d60cef49-213e-4262-81ba-e22f728fd840)
### 基本工作过程
![1725520943865](https://github.com/user-attachments/assets/75da79fa-3e97-4dcf-8e3b-5726fe8be309)

### RIP路由条目更新规则
![1725520959711](https://github.com/user-attachments/assets/d0c908c3-7706-42ad-9155-8e6a36153992)
### RIP坏消息传的慢的问题
![1725520978402](https://github.com/user-attachments/assets/569d8647-589d-462d-9c11-f5698b6fcbb7)
## OSPF
### 基本概念
![1725521290050](https://github.com/user-attachments/assets/1b3b7754-90be-4838-bad0-efe541840c90)
- 区域边界路由器：主干区域内，用于连接主干区域和其他下层区域的路由器
- 只要在主干区域中的路由器都叫做主干路由器
- 主干路由器可以兼做区域边界路由器
- 自治系统有4类路由器：区域内部路由器，主干路由器，区域边界路由器，自治域边界路由器
### 链路的代价
![1725521345311](https://github.com/user-attachments/assets/4fd1e603-027b-446f-8fbe-176888ff9217)

### 交互问候分组
![1725521328769](https://github.com/user-attachments/assets/5d5b3549-093a-4dda-9cf5-73bdeaf62a9a)

### 计算最短路径的过程
![1725521360439](https://github.com/user-attachments/assets/f663aac5-881c-4216-84b2-cd50b3577afa)

### 五种分组类型
![1725521378760](https://github.com/user-attachments/assets/7674026d-975a-45db-ba1d-6c1d2624b376)
### OSPF的基本工作过程
![1725521399087](https://github.com/user-attachments/assets/596ea70f-24ef-4d3a-b239-887ccee8b2b7)
### DR和BDR
![1725521421255](https://github.com/user-attachments/assets/1a46dbe2-bb0e-4b30-ad6c-96ac9bca8b19)
### 区域
![1725521440336](https://github.com/user-attachments/assets/39f471cc-c737-4009-bdd1-0b55dfc5165a)
### 总结
![1725521470201](https://github.com/user-attachments/assets/bf569d6a-261e-4d0b-a282-9e227529fd26)
## BGP
BGP交换的网络可达性信息即：要到达某个网络所要结果的一系列自治系统/路径

![1725521496481](https://github.com/user-attachments/assets/d03c45ba-2ef1-40d1-bd86-95eb3a3b8140)
# IP协议相关技术
## ICMP
### 概述
![1725521518576](https://github.com/user-attachments/assets/87694b89-68aa-4e70-b980-ba11d0a61d8c)
### 五种差错报文
![1725521542779](https://github.com/user-attachments/assets/e611797f-d2c2-4f9b-acd7-18ccc45c7de4)

![1725521564814](https://github.com/user-attachments/assets/798aec14-7d3c-4092-b469-098a903fcd27)

![1725521612243](https://github.com/user-attachments/assets/07d57dba-1b75-4ea8-b9c1-e8feee006bab)
### 不应该发送差错报文的情况
![1725521630035](https://github.com/user-attachments/assets/cc0f3df2-fafa-468a-8920-1b3d5d2dce14)
### ICMP询问方式
![1725521652161](https://github.com/user-attachments/assets/4aaf0c36-666b-4891-896c-b4bc57359511)
### ICMP应用
![1725521677694](https://github.com/user-attachments/assets/38dde04f-d197-49f1-bca3-d9ffe6c5c3b3)

![1725521754249](https://github.com/user-attachments/assets/e5660e1d-a16d-4672-865d-42d00ab6deae)

# ARP协议【IP地址到MAC地址的映射】
## 主要内容
- ARP广播只在子网中传播
- 硬件地址只具有本地意义，每当路由器将IP数据报转发到一个具体的网络时，都需要重新封装源硬件地址和目的硬件地址
- 路由器在收到分组后，剥离该分组的数据链路层协议头，然后在分组被转发之前，给分组加上一个新的链路层协议头
- ARP请求是广播发送【由于不知道目标设备在哪里】
- ARP响应式单播发送
## APR过程
- 目的主机在本局域网
	- 先在ARP高速缓存中查看有无目的IP地址与MAC地址的映射
	- 有，则把硬件地址写入MAC帧，然后通过局域网把该MAC帧发往此硬件地址
	- 无，则通过广播ARP请求分组，在获得目的主机的ARP响应分组后，将目的主机的IP地址与硬件地址写入ARP告诉缓存
- 目的主机不在本局域网
	- 将IP分组发送给本局域网的路由器，先通过上述方式获得路由器的IP地址和硬件地址的映射关系
# DHCP【动态主机配置协议】
## 主要内容
![1725521780175](https://github.com/user-attachments/assets/0fd8fbfe-259f-4805-9c99-e701da15586f)

## DHCP过程
![1725521802103](https://github.com/user-attachments/assets/568d5511-977a-43b5-aeeb-69408210f071)
## 虚拟专用网VPN和网络地址转换NAT
## 公有地址和私有地址
![Pasted image 20240527211414](https://github.com/user-attachments/assets/4a619fe2-8edd-4ac8-9f0c-075aff9b97c6)

## 虚拟专用网VPN
![1725521883191](https://github.com/user-attachments/assets/82b10972-d0d0-47fa-8c94-d0420a04ed19)

## 网络地址转换NAT
![1725521902176](https://github.com/user-attachments/assets/cf0e1b2a-cffa-4a1e-b307-5346a19e11a5)
## NAT转换流程
![1725521919783](https://github.com/user-attachments/assets/fd07da67-187c-4e14-8c67-653a30fd8651)
- 上图有两个客户端 192.168.1.10 和 192.168.1.11
- 与服务器 183.232.231.172 进行通信，并且这两个客户端的本地端口都是 1025
- 此时，两个私有 IP 都转换 IP 为公有地址 120.229.175.121，但以不同的端口号作为区分
- 于是，生成一个 NAPT 路由器的转换表
- 该表可以正确地转换地址跟端口的组合，令客户端 A、B 能同时与服务器之间进行通信
- 这种转换表在 NAT 路由器上自动生成。
	- 例如，在 TCP 的情况下，建立 TCP 连接首次握手时的 SYN 包一经发出，就会生成这个表
	- 后又随着收到关闭连接时发出 FIN 包的确认应答从表中被删除
