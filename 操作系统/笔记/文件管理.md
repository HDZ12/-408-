# 文件
- 文件是以硬盘为载体的存储在计算机上的信息集合
- 文件可以是文本文档，图片，程序
- 用户进行的输入输出中，以文件为基本单位
### 文件组成
1. 一块存储空间
2. 分类和索引的信息
3. 关于访问权限的信息
### 属性
- 文件名；文件类型
- 创建者；所有者
- 位置；大小；保护；创建信息
## 文件数据结构
###  目录项
#### 相关概念
- 目录项/FCB = 用来记录文件的名字，索引节点指针以及其他目录项的层级关联关系
- 目录/目录文件 = FCB的集合
- 为了实现”按名存取“，在文件系统中为每个文件设置用于描述和控制文件的数据结构，称作文件控制块FCB，也叫做目录项
- 目录也被视作一个文件，该文件叫做目录文件
- 目录项是由内核维护的一个数据结构，缓存在内存，目录项文件存储在磁盘
- 目录文件存放该目录中所有子目录文件和数据文件的目录
#### 包含信息
- 基本信息：文件名；文件物理位置，文件逻辑结构，文件物理结构
- 存取控制信息：文件主用户，核准用户或一般用户的存取权限
- 使用信息：文件创立时间，上次修改时间
### 索引节点
#### 概念
- 索引节点是用来记录文件的元信息，是文件的唯一表示
- 索引节点同样占用磁盘空间
- 将文件描述信息从目录项中分离，即应用了索引节点的方法
- 使用索引节点可以减少查找文件时的I/O信息量
#### 分类
磁盘索引节点
- 指存放在磁盘上的索引节点，每个文件有一个唯一的磁盘索引节点
- 包含内容：文件主标识符；文件类型；文件存取权限；文件物理地址；文件长度；文件链接计数；文件存取时间
内存索引节点
- 指存放在内存中的索引节点，文件打开后，将磁盘索引节点复制到内存中
- 新增内容：索引节点编号；状态；访问计数；逻辑设备号；链接指针

![1725253057887](https://github.com/user-attachments/assets/65b4243d-f02e-4ecf-ae1d-6f5ffab25ece)
## 文件操作
### 基本操作
 创建文件；写文件；读文件；重新定位文件；删除文件；截断文件
### 文件打开的过程
- 文件打开就是调用open，根据文件名搜索目录，将指明文件的属性（包括该文件在外存上的物理地址）  
    从外存复制到内存打开文件表的一个表目中，并将该表目的编号（也叫索引）返回给用户
- 【打开文件操作的主要工作就是把指定文件的目录复制到内存指定的区域】
- 【open操作会把文件的FCB调入内存，而不会把文件内容读到内存，只有进程希望获取文件内容时才会读入文件内容】

### 文件打开和关闭关联的信息
文件指针，文件打开计数，文件磁盘位置，访问权限
文件描述符是打开文件的标识
## 文件保护
1. 保护的目的: 解决对文件的读，写，执行的许可问题
2. 一个文件的访问常由用户访问权限和文件属性（包括保存在FCB中对文件访问的控制信息）共同设置
### 保护方式
#### 非访问控制方式
|     |                                        |                   |
| --- | -------------------------------------- | ----------------- |
|     | 1.口令                                   | 2.加密保护            |
| 定义  | - 用户建立一个文件时需要提供口令<br>- 用户请求访问时必须提供相应口令 | - 对文件进行加密，访问时需要密钥 |
| 优点  | - 时间空间开销不多                             | - 保密性强，节省了存储空间    |
| 缺点  | - 口令直接存在系统内部，不安全                       | - 编码和译码需要时间       |
#### 访问控制方法
- 访问控制的目的：用于控制用户对文件的访问方式
- 访问控制的对象：读；写；执行；添加；删除；列表清单
- 访问控制机制必须由系统实现

|     |                                                  |                                      |
| --- | ------------------------------------------------ | ------------------------------------ |
|     | 方法一                                              | 方法二                                  |
| 定义  | - 为每个文件和目录增加一个访问控制列表ACL<br>- 该表规定每个用户名及其所允许的空间管理 | - 采用精简的访问列表<br>- 该列表采用拥有者，组和其他三种用户类型 |
| 优点  | - 可以使用复杂的访问方法                                    | - 只需要三个域即可列出访问表中这三类用户的访问权限           |
| 缺点  | - 长度无法预计并且可能导致复杂的空间管理                            |                                      |

## 文件的逻辑结构【用户角度】
### 无结构文件/流式文件
- 最简单的文件组织形式，是有序相关信息项的集合，以字节为单位
- 对基本信息单元操作不多的文件适合该方式，如源代码文件，目标代码文件
### 有结构文件/记录式文件
| 1.顺序文件   | • 串结构：只能按顺序查找，费时                   |
| -------- | ---------------------------------- |
|          | • 顺序结构：可采用折半查找，检索效率高               |
|          | • 顺序查找平均次数N/2；索引顺序查找平均次数 $N^{1/2}$ |
| 2.索引文件   | • 提高了存取速度，但索引表增加了存储空间              |
| 3.索引顺序文件 | • 同一组中的关键字可以无序，但组与组之间的关键字必须有序      |
|          | • 先通过索引表查找所在的组，然后在该组中使用顺序查找        |
## 文件的物理结构【文件在外存上的存储】
### 定义
- 研究文件数据在物理存储设备上是如何分布和组织的
- 文件在磁带上--->连续存放方式
- 文件在磁盘上--->不采用连续存放方式
- 文件在内存上--->随机存放方式

### 文件存储方式
⽂件的存储就是对磁盘⾮空闲块的管理

| 方式 | 访问磁盘次数 | 优点 | 缺点 |
| --- | --- | --- | --- |
| 顺序分配 | 需访问磁盘1次 | 顺序存取速度快，当文件是定 长时可以根据文件起始地址及 记录长度进行随机访问 | 要求连续的存储空间，会产生 外部碎片，不利于文件的动态 扩充 |
| 链表分配  | 需访问磁盘n次 | 无外部碎片，提高了外存空间 的利用率，动态增长较方便 | 只能按照文件的指针链顺序访 问，查找效率低，指针信息存 放消耗内存或磁盘空间 |
| 索引分配 | m级需访问磁盘 +1次 | 可以随机访问，易于文件的增 删 | 素引表增加存储空间的开销， 索引表的查找策略对文件系统 效率影响较大 |
## 目录
### 目录结构
|         |                                                                         |                                             |                                                  |
| ------- | ----------------------------------------------------------------------- | ------------------------------------------- | ------------------------------------------------ |
|         | 定义                                                                      | 优点                                          | 缺点                                               |
| 单级目录结构  | - 整个文件系统只建立一张目录表<br>- 每个文件占一个目录项                                        |                                             | - 查找速度慢<br>- 文件不允许重名<br>- 不便于文件共享<br>- 不适合多用户的OS |
| 两级目录结构  | - 文件目录分为主文件目录MDF和用户文件目录UFD<br>- MDF记录用户名UFD所在的存储位置<br>- UFD记录用户文件的FCB信息 | - 解决了多用户之间的文件重名问题<br><br>- 文件系统可以在目录上实现访问限制 | - 缺乏灵活性，不能对文件分类                                  |
| 🌲型目录结构 | - 使用绝对路径，相对路径，当前路径的结构<br>- 不同的用户的文件，文件名可相同可不同<br><br>- 大多OS采用这种目录结构     | - 可以很方便的对文件进行分类<br>- 能够有效地进行文件的管理和保护        | - 利于文件共享<br>- 查找文件增加了磁盘访问次数，会影响查询速度              |
| 无环图目录结构 | - 在树形目录结构上<br>- 加入有向边，组成一个有向无环图                                         | - 实现了文件共享                                   | - 使系统的管理变得更加复杂                                   |
### 文件共享
|       | 基于索引节点的关系方式【硬链接】                                                | 基于符号链实现文件共享【软链接】                                   |
| ----- | --------------------------------------------------------------- | -------------------------------------------------- |
| 定义    | - 硬链接就是多个指针指向一个索引节点<br>- 文件的物理地址和其他文件属性信息放在索引节点中                | - 软链接相当于重新创建一个文件<br>- 新文件只包含被链接文件的路径名              |
| 特点    | - 硬链接不可用于跨文件系统<br>- 硬链接查找速度比软链接快                                | - 软链接可以跨文件系统                                       |
| 新增文件时 | - 建立硬链接时，引用计数值加1                                                | - 符号链接，计数值直接复制                                     |
| 删除文件时 | - 删除文件时，计数值减1<br>- 若得到的值不为0，则不能删除此文件<br>- 即只要还有一个指针在，索引节点就不会被删除 | - 删除操作对符号链接不可见<br>- 以后再通过符号链接访问时，若发现文件不存在，直接删除符号链接 |
## 文件系统
### 基本概念
- 文件系统 = OS中负责管理持久数据的子系统
- 文件系统 = 与文件管理有关的软件 + 被管理的文件 + 文件管理所需的数据结构
- 文件系统需先挂载到某个目录才可正常使用
- 文件的基本操作单位就是数据块
### 目标
1. 实现对文件的基本操作 = 按名存储和查找文件 + 组织成合适的结构 + 文件共享 + 文件保护【用户角度】
2. 管理与磁盘的信息交换 + 完成逻辑结构和物理结构的变换【OS角度】
3. 组织文件在磁盘上的存放 + 采取好的文件排放顺序和磁盘调度方法【OS角度】
### 文件系统的层次结构
|        | 主要功能和介绍                                                                                                                  |
| ------ | ------------------------------------------------------------------------------------------------------------------------ |
| I/O控制  | <br>\| 设备驱动程序 \| - 将输入的命令翻译成底层硬件的特定指令 \|<br>\| ------ \| -------------------- \|<br>\| 中断处理程序 \| - 利用指令使IO设备与系统交互     \| |
| 基本文件系统 | - 向对应的设备驱动程序发送通用命令，以读取和写入磁盘的物理块<br>- 管理内存缓冲区，保存各种文件系统，目录和数据块的缓冲                                                          |
| 文件组织模块 | - 组织文件及其逻辑块和物理块<br>- 可以将逻辑地址转换为物理地址<br>- 有空闲空间管理器，以跟踪未分配的块，根据需要提供给文件组织模块                                                 |
| 逻辑文件系统 | - 用于管理元数据信息（包括文件系统的所有结构，不包括文件内容）<br>- 管理目录结构<br>- 通过FCB维护文件结构<br>- 负责文件保护                                                |
### 文件系统的布局
#### 在磁盘中的结构
![1725257222312](https://github.com/user-attachments/assets/888d8878-1378-4b4e-bf5d-f027763e15fe)
- 最前面的第一个块是引导块，在系统启动时用于启用引导
- 接着后面就是一个一个连续的块组了，块组的内容如下

| 超级块      | • 包含的是文件系统的重要信息                                   |
|----------|---------------------------------------------------|
|          | • 比如 inode 总个数、块总个数、每个块组的 inode 个数、每个块组的块个数       |
| 块组描述符    | • 包含文件系统中各个块组的状态                                  |
|          | • 比如块组中空闲块和 inode 的数目等，每个块组都包含了文件系统中「所有块组的组描述符信息」 |
| 数据位图     |
| inode 位图 | • 用于表示对应的数据块或 inode 是空闲的，还是被使用中                   |
| inode 列表 | • 包含了块组中所有的 inode，inode 用于保存文件系统中与各个文件和目录相关的所有元数据 |
| 数据块      | • 包含文件的有用数据                                       |
### 在内存中的结构
• 内存中的信息用于管理文件系统并通过缓存来提高信息
• 这些结构有以下类型
	○ 内存中的安装表
	○ 内存中的目录结构的缓存包含最近访问目录的信息
	○ 整个系统的打开文件表
	○ 每个进程的打开文件表
### 外存空闲空间的管理
#### 空闲表法
![1725257642736](https://github.com/user-attachments/assets/c4a19740-82ce-40e7-b0af-ff2544e02496)
对比内存中的动态空闲区分配
#### 空闲链表法
- 空闲盘块链
- 空闲盘区链
#### 位示图
![1725257846567](https://github.com/user-attachments/assets/f150fa43-58d4-41cd-93e2-eb38ed97330b)
#### 成组链表法
![1725258026305](https://github.com/user-attachments/assets/1a54ae08-0e4e-44da-9c67-f70defea8b7b)
## 虚拟文件系统VFS

| 目的       | - 为用户程序提供了文件系统操作的统一接口，屏蔽了不同文件系统差异和操作细节                                         |
| -------- | ------------------------------------------------------------------------------ |
| 特性       | 1. 能提高系统性能<br>2. 不是一种实际的文件系统<br>3. 只存在于内存中，不存在于任何外存空间中<br>4. 在系统启动时建立，在系统关闭时消亡 |
| VFS的数据结构 | 1. 超级块对象<br>2. 索引节点对象<br>3. 目录项对象<br>4. 文件对象                                   |
## 文件系统挂载
- 一个磁盘可划分为多个区，每个分区都可以创建单独的文件系统，每个分区都可包含不同的操作系统
- 文件在使用前必须先安装（即挂载）
